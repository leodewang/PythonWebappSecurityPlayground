name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-scan-patch-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ secrets.ACR_NAME }}
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }} .
        docker tag ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }} \
                   ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:latest
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: '${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }}'
        format: 'json'
        output: 'trivy-report.json'
        
    - name: Install Copacetic
      run: |
        # Install copa CLI - get latest release
        COPA_VERSION=$(curl -sL https://api.github.com/repos/project-copacetic/copacetic/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
        if [ -z "$COPA_VERSION" ]; then
          echo "Failed to fetch Copa version, using fallback"
          COPA_VERSION="0.7.0"
        fi
        echo "Installing Copa version: $COPA_VERSION"
        wget https://github.com/project-copacetic/copacetic/releases/latest/download/copa_${COPA_VERSION}_linux_amd64.tar.gz
        tar -xzf copa_${COPA_VERSION}_linux_amd64.tar.gz
        sudo mv copa /usr/local/bin/
        
    - name: Install buildkit
      run: |
        docker run --detach --rm --privileged -p 127.0.0.1:8888:8888/tcp --name buildkitd moby/buildkit:latest --addr tcp://0.0.0.0:8888
        
    - name: Patch vulnerabilities with Copa
      run: |
        # Export image to tar
        docker save ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }} -o python-webapp.tar
        
        # Patch the image - Copa may not patch all vulnerabilities
        # It primarily patches OS-level vulnerabilities
        set +e
        copa patch \
          -i python-webapp.tar \
          -r trivy-report.json \
          -t ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }}-patched \
          -a tcp://127.0.0.1:8888
        COPA_EXIT_CODE=$?
        set -e
        
        if [ $COPA_EXIT_CODE -eq 0 ]; then
          echo "✓ Copa patching completed successfully"
          # Tag patched image as latest
          docker tag ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }}-patched \
                     ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:latest
        else
          echo "⚠ Copa patching completed with warnings (exit code: $COPA_EXIT_CODE)"
          echo "Using original image as latest"
          docker tag ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }} \
                     ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:latest
        fi
        
    - name: Push images to ACR
      run: |
        # Push original image
        docker push ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }}
        
        # Push patched image if it exists
        if docker image inspect ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }}-patched &> /dev/null; then
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:${{ env.IMAGE_TAG }}-patched
        fi
        
        # Push latest tag (will be patched version if patching succeeded)
        docker push ${{ secrets.ACR_NAME }}.azurecr.io/python-webapp:latest
        
    - name: Cleanup buildkit
      if: always()
      run: |
        docker stop buildkitd || true

  deploy-to-aks:
    needs: build-scan-patch-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
          --name ${{ secrets.AKS_CLUSTER_NAME }} \
          --overwrite-existing
          
    - name: Deploy to AKS
      run: |
        # Replace placeholders in manifests
        sed -i "s/\${ACR_NAME}/${{ secrets.ACR_NAME }}/g" k8s/deployment.yaml
        sed -i "s/\${IMAGE_TAG}/${{ env.IMAGE_TAG }}/g" k8s/deployment.yaml
        
        # Apply Kubernetes manifests
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        
    - name: Wait for deployment
      run: |
        kubectl rollout status deployment/python-webapp --timeout=5m
        
    - name: Get service endpoint
      run: |
        echo "Waiting for LoadBalancer IP..."
        kubectl get service python-webapp
        
        # Try to get external IP (may take a few minutes)
        EXTERNAL_IP=""
        for i in {1..12}; do
          EXTERNAL_IP=$(kubectl get service python-webapp -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          if [ -n "$EXTERNAL_IP" ]; then
            echo "Application deployed successfully!"
            echo "External IP: $EXTERNAL_IP"
            echo "Access your application at: http://$EXTERNAL_IP"
            break
          fi
          echo "Waiting for external IP... (attempt $i/12)"
          sleep 10
        done
        
        if [ -z "$EXTERNAL_IP" ]; then
          echo "External IP not yet assigned. Check later with: kubectl get service python-webapp"
        fi
